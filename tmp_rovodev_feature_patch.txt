# Remaining changes needed for 3 critical features

## 1. Initialize new fields in newSession() - Around line 3662

Find the block that initializes sessionConfig (around line 3662):
```
enableFileCheckpointingValueId:
```

Add after sandboxValueId initialization (around line 3666):
```typescript
enablePartialMessagesValueId:
  params._meta?.claudeCode?.sessionConfig?.enablePartialMessages === false
    ? "disabled"
    : "enabled",
betasValueId: params._meta?.claudeCode?.sessionConfig?.betas ? "custom" : "default",
systemPromptValueId: params._meta?.claudeCode?.sessionConfig?.systemPrompt
  ? "custom"
  : "default",
```

## 2. Update includePartialMessages - Line 3488

FIND:
```typescript
includePartialMessages: true,
```

REPLACE WITH:
```typescript
includePartialMessages: session.sessionConfig.enablePartialMessagesValueId === "enabled",
```

## 3. Add betas support - Around line 3490 (in Options object)

After the includePartialMessages line, add:
```typescript
betas: params._meta?.claudeCode?.sessionConfig?.betas,
```

## 4. Update systemPrompt logic - Around line 3296

FIND (around line 3296-3310):
```typescript
let systemPrompt: Options["systemPrompt"] = { type: "preset", preset: "claude_code" };
```

REPLACE WITH:
```typescript
let systemPrompt: Options["systemPrompt"] = { type: "preset", preset: "claude_code" };

// Priority: sessionConfig > _meta.systemPrompt > default
if (params._meta?.claudeCode?.sessionConfig?.systemPrompt) {
  systemPrompt = params._meta.claudeCode.sessionConfig.systemPrompt;
} else if (params._meta?.systemPrompt) {
  // Legacy support for old _meta.systemPrompt format
  const customPrompt = params._meta.systemPrompt;
  if (typeof customPrompt === "string") {
    systemPrompt = customPrompt;
  } else if (typeof customPrompt === "object") {
    systemPrompt = { type: "preset", preset: "claude_code" };
    if (customPrompt.append) {
      systemPrompt.append = customPrompt.append;
    }
  }
}
```

## 5. Add runtime update handler for enablePartialMessages in setSessionConfigOption()

Find the setSessionConfigOption method and add handling for the new config IDs.
This method should handle runtime updates to enablePartialMessages (the only runtime-mutable one).

The others (betas, systemPrompt) are creation-time only, so they just display state.
